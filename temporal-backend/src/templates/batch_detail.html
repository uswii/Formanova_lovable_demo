{% extends "base.html" %}
{% block title %}Batch {{ batch.id[:8] }} - FormaNova Admin{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="/admin/batches" class="text-gray-400 hover:text-white text-sm">‚Üê Back to Batches</a>
</div>

<div class="mb-8">
    <div class="flex items-center gap-4 mb-2">
        <h1 class="text-3xl font-bold font-mono">{{ batch.id[:16] }}...</h1>
        <span class="status-{{ batch.status }} px-3 py-1 rounded text-sm font-medium capitalize">
            {{ batch.status }}
        </span>
    </div>
    <p class="text-gray-400">Submitted by {{ batch.user_email or 'Unknown user' }}</p>
</div>

<!-- Batch Info Grid -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Details Card -->
    <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
        <h3 class="text-lg font-semibold mb-4 text-gold-400">Batch Details</h3>
        <dl class="space-y-3">
            <div class="flex justify-between">
                <dt class="text-gray-400">Category</dt>
                <dd class="text-white capitalize">{{ batch.jewelry_category }}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Skin Tone</dt>
                <dd class="text-white capitalize">{{ batch.skin_tone }}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Gender</dt>
                <dd class="text-white capitalize">{{ batch.gender }}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Total Images</dt>
                <dd class="text-white">{{ batch.total_images }}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Is Free Batch</dt>
                <dd class="text-white">{{ 'Yes' if batch.is_free_batch else 'No' }}</dd>
            </div>
        </dl>
    </div>
    
    <!-- Progress Card -->
    <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
        <h3 class="text-lg font-semibold mb-4 text-gold-400">Progress</h3>
        <div class="mb-4">
            <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-400">Completion</span>
                <span class="text-white">{{ batch.progress_percentage|round(1) }}%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
                <div class="bg-green-500 h-2 rounded-full transition-all" style="width: {{ batch.progress_percentage }}%"></div>
            </div>
        </div>
        <dl class="space-y-3">
            <div class="flex justify-between">
                <dt class="text-gray-400">Completed</dt>
                <dd class="text-green-400">{{ batch.completed_images }}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Failed</dt>
                <dd class="text-red-400">{{ batch.failed_images }}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Pending</dt>
                <dd class="text-yellow-400">{{ batch.total_images - batch.completed_images - batch.failed_images }}</dd>
            </div>
        </dl>
    </div>
    
    <!-- Timestamps Card -->
    <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
        <h3 class="text-lg font-semibold mb-4 text-gold-400">Timestamps</h3>
        <dl class="space-y-3">
            <div class="flex justify-between">
                <dt class="text-gray-400">Created</dt>
                <dd class="text-white text-sm">{{ batch.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Started</dt>
                <dd class="text-white text-sm">{{ batch.processing_started_at.strftime('%Y-%m-%d %H:%M:%S') if batch.processing_started_at else '-' }}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Completed</dt>
                <dd class="text-white text-sm">{{ batch.completed_at.strftime('%Y-%m-%d %H:%M:%S') if batch.completed_at else '-' }}</dd>
            </div>
            <div class="flex justify-between">
                <dt class="text-gray-400">Est. Completion</dt>
                <dd class="text-white text-sm">{{ batch.estimated_completion_at.strftime('%Y-%m-%d %H:%M:%S') if batch.estimated_completion_at else '-' }}</dd>
            </div>
        </dl>
    </div>
</div>

<!-- User Info -->
<div class="bg-gray-900 rounded-lg p-6 border border-gray-800 mb-8">
    <h3 class="text-lg font-semibold mb-4 text-gold-400">User Information</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <div class="text-gray-400 text-sm">User ID</div>
            <div class="font-mono text-sm">{{ batch.user_id }}</div>
        </div>
        <div>
            <div class="text-gray-400 text-sm">Email</div>
            <div class="text-white">{{ batch.user_email or 'Not available' }}</div>
        </div>
        <div>
            <div class="text-gray-400 text-sm">Tenant ID</div>
            <div class="font-mono text-sm">{{ batch.tenant_id or '-' }}</div>
        </div>
        <div>
            <div class="text-gray-400 text-sm">Credits Charged</div>
            <div class="text-white">{{ batch.credits_charged }}</div>
        </div>
    </div>
</div>

<!-- Error Message -->
{% if batch.error_message %}
<div class="bg-red-900/20 border border-red-800 rounded-lg p-4 mb-8">
    <h3 class="text-red-400 font-semibold mb-2">Error Message</h3>
    <pre class="text-red-300 text-sm whitespace-pre-wrap">{{ batch.error_message }}</pre>
</div>
{% endif %}

<!-- Images Table -->
<div class="bg-gray-900 rounded-lg border border-gray-800 overflow-hidden">
    <div class="bg-gray-800 px-4 py-3 flex justify-between items-center">
        <h3 class="text-lg font-semibold">Batch Images</h3>
        <span class="text-gray-400 text-sm">{{ images|length }} images</span>
    </div>
    <table class="w-full">
        <thead class="bg-gray-800/50">
            <tr>
                <th class="text-left px-4 py-3 text-sm font-medium text-gray-400">#</th>
                <th class="text-left px-4 py-3 text-sm font-medium text-gray-400">Preview</th>
                <th class="text-left px-4 py-3 text-sm font-medium text-gray-400">Original URL</th>
                <th class="text-left px-4 py-3 text-sm font-medium text-gray-400">Result URL</th>
                <th class="text-left px-4 py-3 text-sm font-medium text-gray-400">Status</th>
                <th class="text-left px-4 py-3 text-sm font-medium text-gray-400">Flags</th>
                <th class="text-left px-4 py-3 text-sm font-medium text-gray-400">Processing Time</th>
                <th class="text-left px-4 py-3 text-sm font-medium text-gray-400">Workflow</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-800">
            {% for img in images %}
            <tr class="hover:bg-gray-800/50 transition {{ 'bg-pink-900/10' if img.is_flagged else '' }}">
                <td class="px-4 py-3 text-sm text-gray-400">{{ img.sequence }}</td>
                <td class="px-4 py-3">
                    {% if img.original_azure_uri %}
                    <img src="{{ img.original_sas_url or img.original_azure_uri }}" 
                         alt="Original" 
                         class="w-16 h-16 object-cover rounded border border-gray-700"
                         onerror="this.src='/placeholder.svg'">
                    {% else %}
                    <div class="w-16 h-16 bg-gray-800 rounded border border-gray-700 flex items-center justify-center text-gray-500 text-xs">
                        No image
                    </div>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-xs">
                    {% if img.original_azure_uri %}
                    <a href="{{ img.original_sas_url or img.original_azure_uri }}" 
                       target="_blank" 
                       class="text-blue-400 hover:text-blue-300 font-mono break-all">
                        {{ img.original_azure_uri[:40] }}...
                    </a>
                    {% else %}
                    <span class="text-gray-500">-</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-xs">
                    {% if img.result_azure_uri %}
                    <a href="{{ img.result_sas_url or img.result_azure_uri }}" 
                       target="_blank" 
                       class="text-green-400 hover:text-green-300 font-mono break-all">
                        {{ img.result_azure_uri[:40] }}...
                    </a>
                    {% else %}
                    <span class="text-gray-500">-</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm">
                    <span class="status-{{ img.status }} px-2 py-1 rounded text-xs font-medium capitalize">
                        {{ img.status }}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm">
                    {% if img.is_flagged %}
                    <span class="status-flagged px-2 py-1 rounded text-xs font-medium">
                        {{ img.flag_reason or 'Flagged' }}
                    </span>
                    {% else %}
                    <span class="text-gray-500">-</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-gray-400">
                    {{ '%d ms' % img.processing_time_ms if img.processing_time_ms else '-' }}
                </td>
                <td class="px-4 py-3 text-xs font-mono text-gray-500">
                    {{ img.workflow_id[:12] + '...' if img.workflow_id else '-' }}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="px-4 py-8 text-center text-gray-500">No images in this batch</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
