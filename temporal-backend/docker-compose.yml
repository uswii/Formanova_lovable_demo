version: "3.8"

services:
  # Temporal Server (all-in-one for development)
  temporal:
    image: temporalio/auto-setup:1.22.4
    container_name: temporal
    ports:
      - "7233:7233"
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=temporal
      - POSTGRES_PWD=temporal
      - POSTGRES_SEEDS=postgres
    depends_on:
      - postgres
    networks:
      - temporal-network

  # Temporal Web UI
  temporal-web:
    image: temporalio/ui:2.22.3
    container_name: temporal-web
    ports:
      - "8088:8080"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000,http://localhost:8080
    depends_on:
      - temporal
    networks:
      - temporal-network

  # PostgreSQL for Temporal
  postgres:
    image: postgres:15
    container_name: temporal-postgres
    environment:
      - POSTGRES_USER=temporal
      - POSTGRES_PASSWORD=temporal
    ports:
      - "5432:5432"
    volumes:
      - temporal-postgres-data:/var/lib/postgresql/data
    networks:
      - temporal-network

  # Temporal API Gateway (FastAPI)
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: temporal-api
    ports:
      - "8001:8001"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_NAMESPACE=default
      - AZURE_ACCOUNT_NAME=${AZURE_ACCOUNT_NAME}
      - AZURE_ACCOUNT_KEY=${AZURE_ACCOUNT_KEY}
      - AZURE_CONTAINER_NAME=${AZURE_CONTAINER_NAME:-jewelry-uploads}
      - IMAGE_MANIPULATOR_URL=${IMAGE_MANIPULATOR_URL:-http://20.106.235.80:8005}
      - BIREFNET_URL=${BIREFNET_URL:-https://nemoooooooooo--bg-remove-service-fastapi-app.modal.run}
      - SAM3_URL=${SAM3_URL:-https://nemoooooooooo--sam3-service-fastapi-app.modal.run}
      - A100_SERVER_URL=${A100_SERVER_URL:-http://host.docker.internal:8000}
    depends_on:
      - temporal
    networks:
      - temporal-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Temporal Worker
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: temporal-worker
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_NAMESPACE=default
      - AZURE_ACCOUNT_NAME=${AZURE_ACCOUNT_NAME}
      - AZURE_ACCOUNT_KEY=${AZURE_ACCOUNT_KEY}
      - AZURE_CONTAINER_NAME=${AZURE_CONTAINER_NAME:-jewelry-uploads}
      - IMAGE_MANIPULATOR_URL=${IMAGE_MANIPULATOR_URL:-http://20.106.235.80:8005}
      - BIREFNET_URL=${BIREFNET_URL:-https://nemoooooooooo--bg-remove-service-fastapi-app.modal.run}
      - SAM3_URL=${SAM3_URL:-https://nemoooooooooo--sam3-service-fastapi-app.modal.run}
      - A100_SERVER_URL=${A100_SERVER_URL:-http://host.docker.internal:8000}
    depends_on:
      - temporal
    networks:
      - temporal-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  temporal-network:
    driver: bridge

volumes:
  temporal-postgres-data:
